# ğŸ—ï¸ BrandaoZap Backend - Regras e Boas PrÃ¡ticas

## ğŸ“‹ Arquitetura

### Estrutura de MÃ³dulos (NestJS)

```
src/
â”œâ”€â”€ main.ts                    # Bootstrap da aplicaÃ§Ã£o
â”œâ”€â”€ app.module.ts              # MÃ³dulo raiz
â”œâ”€â”€ config/                    # ConfiguraÃ§Ãµes
â”‚   â”œâ”€â”€ database.config.ts
â”‚   â”œâ”€â”€ waha.config.ts
â”‚   â””â”€â”€ app.config.ts
â”œâ”€â”€ common/                    # UtilitÃ¡rios compartilhados
â”‚   â”œâ”€â”€ decorators/
â”‚   â”œâ”€â”€ filters/
â”‚   â”œâ”€â”€ guards/
â”‚   â”œâ”€â”€ interceptors/
â”‚   â””â”€â”€ pipes/
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ auth/                  # AutenticaÃ§Ã£o e autorizaÃ§Ã£o
â”‚   â”‚   â”œâ”€â”€ auth.module.ts
â”‚   â”‚   â”œâ”€â”€ auth.controller.ts
â”‚   â”‚   â”œâ”€â”€ auth.service.ts
â”‚   â”‚   â”œâ”€â”€ strategies/
â”‚   â”‚   â””â”€â”€ guards/
â”‚   â”œâ”€â”€ users/                 # GestÃ£o de usuÃ¡rios
â”‚   â”‚   â”œâ”€â”€ users.module.ts
â”‚   â”‚   â”œâ”€â”€ users.controller.ts
â”‚   â”‚   â”œâ”€â”€ users.service.ts
â”‚   â”‚   â””â”€â”€ entities/
â”‚   â”œâ”€â”€ whatsapp/              # IntegraÃ§Ã£o WAHA
â”‚   â”‚   â”œâ”€â”€ whatsapp.module.ts
â”‚   â”‚   â”œâ”€â”€ whatsapp.controller.ts
â”‚   â”‚   â”œâ”€â”€ whatsapp.service.ts
â”‚   â”‚   â”œâ”€â”€ waha/
â”‚   â”‚   â”‚   â”œâ”€â”€ waha.service.ts
â”‚   â”‚   â”‚   â””â”€â”€ waha.client.ts
â”‚   â”‚   â””â”€â”€ sessions/
â”‚   â”œâ”€â”€ flows/                 # Construtor de fluxos
â”‚   â”‚   â”œâ”€â”€ flows.module.ts
â”‚   â”‚   â”œâ”€â”€ flows.controller.ts
â”‚   â”‚   â”œâ”€â”€ flows.service.ts
â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â””â”€â”€ dto/
â”‚   â”œâ”€â”€ keywords/               # Palavras-chave
â”‚   â”‚   â”œâ”€â”€ keywords.module.ts
â”‚   â”‚   â”œâ”€â”€ keywords.controller.ts
â”‚   â”‚   â”œâ”€â”€ keywords.service.ts
â”‚   â”‚   â””â”€â”€ entities/
â”‚   â”œâ”€â”€ contacts/              # CRM de contatos
â”‚   â”‚   â”œâ”€â”€ contacts.module.ts
â”‚   â”‚   â”œâ”€â”€ contacts.controller.ts
â”‚   â”‚   â”œâ”€â”€ contacts.service.ts
â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â””â”€â”€ tags/
â”‚   â”œâ”€â”€ messages/              # Mensagens e chat
â”‚   â”‚   â”œâ”€â”€ messages.module.ts
â”‚   â”‚   â”œâ”€â”€ messages.controller.ts
â”‚   â”‚   â”œâ”€â”€ messages.service.ts
â”‚   â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â””â”€â”€ webhooks/
â”‚   â”œâ”€â”€ campaigns/              # Campanhas e disparos
â”‚   â”‚   â”œâ”€â”€ campaigns.module.ts
â”‚   â”‚   â”œâ”€â”€ campaigns.controller.ts
â”‚   â”‚   â”œâ”€â”€ campaigns.service.ts
â”‚   â”‚   â””â”€â”€ entities/
â”‚   â”œâ”€â”€ templates/             # Biblioteca de robÃ´s
â”‚   â”‚   â”œâ”€â”€ templates.module.ts
â”‚   â”‚   â”œâ”€â”€ templates.controller.ts
â”‚   â”‚   â”œâ”€â”€ templates.service.ts
â”‚   â”‚   â””â”€â”€ entities/
â”‚   â””â”€â”€ agents/                # Atendentes
â”‚       â”œâ”€â”€ agents.module.ts
â”‚       â”œâ”€â”€ agents.controller.ts
â”‚       â”œâ”€â”€ agents.service.ts
â”‚       â””â”€â”€ entities/
â””â”€â”€ database/
    â”œâ”€â”€ migrations/
    â””â”€â”€ seeds/
```

## ğŸ¯ PrincÃ­pios e Regras

### 1. **SeparaÃ§Ã£o de Responsabilidades**
- âœ… Cada mÃ³dulo deve ter responsabilidade Ãºnica e bem definida
- âœ… Services contÃªm lÃ³gica de negÃ³cio
- âœ… Controllers apenas recebem requisiÃ§Ãµes e retornam respostas
- âœ… Entities representam modelos de dados
- âœ… DTOs para validaÃ§Ã£o de entrada/saÃ­da

### 2. **Dependency Injection**
- âœ… Sempre usar injeÃ§Ã£o de dependÃªncias do NestJS
- âœ… Evitar `new Class()` dentro de services
- âœ… Usar interfaces para abstraÃ§Ãµes quando necessÃ¡rio

### 3. **ValidaÃ§Ã£o de Dados**
- âœ… Sempre usar DTOs com `class-validator` e `class-transformer`
- âœ… Validar entrada em todos os endpoints
- âœ… Usar `ValidationPipe` globalmente

### 4. **Tratamento de Erros**
- âœ… Criar exceptions customizadas quando necessÃ¡rio
- âœ… Usar `ExceptionFilter` para tratamento global
- âœ… Retornar mensagens de erro consistentes
- âœ… Logar erros adequadamente

### 5. **Banco de Dados**
- âœ… Usar TypeORM ou Prisma (definir qual)
- âœ… Criar migrations para todas as mudanÃ§as de schema
- âœ… Usar transactions para operaÃ§Ãµes crÃ­ticas
- âœ… Ãndices em campos de busca frequente
- âœ… Soft delete quando apropriado

### 6. **IntegraÃ§Ã£o WAHA**
- âœ… Criar service dedicado para comunicaÃ§Ã£o com WAHA
- âœ… Tratar erros de conexÃ£o/desconexÃ£o
- âœ… Implementar retry logic para requisiÃ§Ãµes falhas
- âœ… Webhooks para receber mensagens em tempo real
- âœ… Gerenciar mÃºltiplas sessÃµes WhatsApp

### 7. **WebSockets**
- âœ… Usar `@nestjs/websockets` para chat em tempo real
- âœ… Gateways separados por funcionalidade
- âœ… AutenticaÃ§Ã£o em conexÃµes WebSocket
- âœ… Gerenciar rooms para conversas

### 8. **SeguranÃ§a**
- âœ… AutenticaÃ§Ã£o JWT obrigatÃ³ria
- âœ… Hash de senhas com bcrypt
- âœ… Rate limiting em endpoints pÃºblicos
- âœ… CORS configurado adequadamente
- âœ… ValidaÃ§Ã£o de inputs para prevenir SQL injection
- âœ… SanitizaÃ§Ã£o de dados de entrada

### 9. **Performance**
- âœ… Cache com Redis para dados frequentes
- âœ… PaginaÃ§Ã£o em listagens
- âœ… Lazy loading de relacionamentos pesados
- âœ… Ãndices de banco de dados otimizados
- âœ… Queries otimizadas (evitar N+1)

### 10. **Testes**
- âœ… Unit tests para services
- âœ… Integration tests para controllers
- âœ… E2E tests para fluxos crÃ­ticos
- âœ… Cobertura mÃ­nima de 70%

### 11. **Logging**
- âœ… Usar Logger do NestJS
- âœ… Logs estruturados (JSON)
- âœ… NÃ­veis apropriados (error, warn, log, debug)
- âœ… NÃ£o logar informaÃ§Ãµes sensÃ­veis

### 12. **Ambiente e ConfiguraÃ§Ã£o**
- âœ… Usar `@nestjs/config` para variÃ¡veis de ambiente
- âœ… ValidaÃ§Ã£o de variÃ¡veis obrigatÃ³rias no startup
- âœ… Diferentes configs para dev/staging/prod
- âœ… NÃ£o commitar `.env` files

### 13. **DocumentaÃ§Ã£o**
- âœ… Swagger/OpenAPI para documentaÃ§Ã£o de API
- âœ… ComentÃ¡rios JSDoc em funÃ§Ãµes complexas
- âœ… README atualizado
- âœ… DocumentaÃ§Ã£o de endpoints

### 14. **CÃ³digo**
- âœ… TypeScript strict mode
- âœ… ESLint e Prettier configurados
- âœ… Nomes descritivos para variÃ¡veis/funÃ§Ãµes
- âœ… FunÃ§Ãµes pequenas e focadas (< 50 linhas)
- âœ… Evitar cÃ³digo duplicado (DRY)

### 15. **Fluxos de Conversa**
- âœ… Estrutura de dados para representar fluxos
- âœ… ValidaÃ§Ã£o de fluxos antes de salvar
- âœ… Engine para executar fluxos
- âœ… Suporte a condiÃ§Ãµes, loops, delays

### 16. **Mensagens**
- âœ… Suporte a texto, imagem, vÃ­deo, Ã¡udio, documentos
- âœ… Templates de mensagens
- âœ… VariÃ¡veis dinÃ¢micas em mensagens
- âœ… HistÃ³rico completo de conversas

### 17. **Campanhas**
- âœ… Agendamento de disparos
- âœ… SegmentaÃ§Ã£o de contatos
- âœ… Rate limiting para evitar bloqueios
- âœ… Status de entrega e leitura

### 18. **Multi-tenancy**
- âœ… Isolamento de dados por usuÃ¡rio/organizaÃ§Ã£o
- âœ… Middleware para identificar tenant
- âœ… Queries filtradas por tenant

## ğŸ“¦ DependÃªncias Recomendadas

```json
{
  "@nestjs/common": "^11.0.0",
  "@nestjs/core": "^11.0.0",
  "@nestjs/config": "^3.0.0",
  "@nestjs/jwt": "^10.0.0",
  "@nestjs/passport": "^10.0.0",
  "@nestjs/websockets": "^11.0.0",
  "@nestjs/platform-socket.io": "^11.0.0",
  "passport": "^0.7.0",
  "passport-jwt": "^4.0.0",
  "bcrypt": "^5.1.0",
  "class-validator": "^0.14.0",
  "class-transformer": "^0.5.1",
  "typeorm": "^0.3.17",
  "pg": "^8.11.0",
  "redis": "^4.6.0",
  "axios": "^1.6.0",
  "socket.io": "^4.5.0"
}
```

## ğŸ”„ Fluxo de Desenvolvimento

1. **Criar mÃ³dulo**: `nest g module modules/nome-modulo`
2. **Criar controller**: `nest g controller modules/nome-modulo`
3. **Criar service**: `nest g service modules/nome-modulo`
4. **Criar entity**: `nest g class modules/nome-modulo/entities/nome-entity`
5. **Criar DTO**: `nest g class modules/nome-modulo/dto/nome-dto`
6. **Criar migration**: `typeorm migration:create`
7. **Testar**: `pnpm test`
8. **Rodar**: `pnpm start:dev`

## ğŸš« Anti-patterns a Evitar

- âŒ LÃ³gica de negÃ³cio em controllers
- âŒ Queries SQL diretas sem ORM
- âŒ Tratamento de erros genÃ©rico demais
- âŒ DependÃªncias circulares
- âŒ CÃ³digo duplicado
- âŒ VariÃ¡veis mÃ¡gicas (usar constants)
- âŒ Callbacks aninhados (usar async/await)
- âŒ Logs de informaÃ§Ãµes sensÃ­veis
